---
- name: Install k3s Cluster (Learning by Doing Edition)
  hosts: masters
  become: yes

  tasks:
    # 1. install k3s
    - name: Download and install k3s
      shell: "curl -sfL https://get.k3s.io | sh -"
      args:
        creates: /usr/local/bin/k3s  # FÃ¼hrt den Befehl nur aus, wenn k3s noch fehlt

    # 2. Wait for k3s to be ready
    - name: Wait for k3s to be ready
      wait_for:
        port: 6443
        delay: 5
        timeout: 300

    # 3. Get kubeconfig file
    - name: Copy kubeconfig to control node
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ../k3s_kubeconfig
        flat: yes

# 4. Adjust kubeconfig for local use
- name: Configure Local Kubeconfig
  hosts: localhost
  connection: local
  tasks:
    - name: Update kubeconfig with server IP
      replace:
        path: ../k3s_kubeconfig
        regexp: '127.0.0.1'
        replace: "{{ groups['masters'][0] }}"